<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Camera Zoom Pro</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Video Preview */
        .preview-area { position: relative; flex: 1; background: #111; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; transition: transform 0.1s; }
        
        /* Overlay UI */
        #status { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; font-size: 12px; z-index: 10; }
        #timer { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 20px; color: #ff3b30; font-weight: bold; text-shadow: 0 0 10px rgba(0,0,0,0.8); display: none; z-index: 10; }

        /* Zoom Control - N√∫t tr√≤n v√† Thanh k√©o ·∫©n hi·ªán */
        .zoom-wrapper { position: absolute; right: 20px; bottom: 100px; display: flex; flex-direction: column; align-items: center; z-index: 30; }
        
        #zoomInputContainer { 
            display: none; 
            background: rgba(0,0,0,0.6); 
            padding: 20px 10px; 
            border-radius: 30px; 
            margin-bottom: 10px; 
            flex-direction: column; 
            align-items: center; 
            gap: 10px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .zoom-slider { appearance: none; width: 180px; height: 6px; background: #444; border-radius: 3px; transform: rotate(-90deg); margin: 80px 0; }
        .zoom-slider::-webkit-slider-thumb { appearance: none; width: 28px; height: 28px; background: #fff; border-radius: 50%; border: 3px solid #007aff; cursor: pointer; shadow: 0 0 10px rgba(0,0,0,0.5); }

        .btn-zoom-toggle { 
            width: 55px; 
            height: 55px; 
            background: rgba(255, 255, 255, 0.2); 
            border: 2px solid #fff; 
            border-radius: 50%; 
            color: #fff; 
            font-size: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .btn-zoom-toggle.active { background: #007aff; border-color: #007aff; }

        /* Controls */
        .controls { background: #000; padding: 15px 0 30px 0; display: flex; flex-direction: column; align-items: center; gap: 15px; border-top: 1px solid #222; }
        .main-actions { display: flex; align-items: center; justify-content: space-around; width: 100%; max-width: 400px; }
        
        .btn-circle { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .btn-snap { background: #fff; border: 5px solid #444; width: 75px; height: 75px; }
        .btn-record { background: #ff3b30; color: #fff; }
        .recording { animation: pulse 1s infinite; border-radius: 15px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Gallery */
        .gallery { width: 100%; overflow-x: auto; white-space: nowrap; padding: 10px; background: #111; display: flex; gap: 10px; height: 90px; }
        .gallery-item-wrapper { position: relative; flex-shrink: 0; }
        .gallery-item { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #333; }
        .delete-btn { position: absolute; top: -5px; right: -5px; background: #ff3b30; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; border: 2px solid #000; display: flex; align-items: center; justify-content: center; z-index: 5; font-weight: bold; }

        /* Modal */
        #modal { display: none; position: fixed; inset: 0; background: #000; z-index: 100; flex-direction: column; }
        #modal-content { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 20px; }
        #modal-content img, #modal-content video { max-width: 100%; max-height: 100%; border-radius: 10px; }
        .modal-btns { padding: 20px; display: flex; justify-content: center; gap: 15px; padding-bottom: 40px; }
        .btn-modal { padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <div class="preview-area">
        <div id="status">Kh·ªüi ƒë·ªông...</div>
        <div id="timer">00:00</div>
        
        <video id="video" autoplay playsinline muted></video>

        <!-- C·ª•m Zoom m·ªõi -->
        <div class="zoom-wrapper">
            <div id="zoomInputContainer">
                <span id="zoom-text" style="font-size: 14px; font-weight: bold; color: #ffcc00;">1.0x</span>
                <input type="range" id="zoomInput" class="zoom-slider" min="1" max="10" step="0.1" value="1">
            </div>
            <button class="btn-zoom-toggle" id="zoomToggle">
                <span>ZOOM</span>
            </button>
        </div>
    </div>

    <div class="gallery" id="gallery"></div>

    <div class="controls">
        <div class="main-actions">
            <button class="btn-circle" onclick="toggleCamera()" style="background:#333; color:white">üîÑ</button>
            <button class="btn-circle btn-snap" onclick="takePhoto()"></button>
            <button id="recordBtn" class="btn-circle btn-record" onclick="toggleRecording()">üé•</button>
        </div>
    </div>

    <!-- Modal Xem l·∫°i -->
    <div id="modal">
        <div id="modal-content"></div>
        <div class="modal-btns">
            <button class="btn-modal" onclick="closeModal()" style="background:#444; color:#fff">ƒê√≥ng</button>
            <button id="delCurrentBtn" class="btn-modal" style="background:#ff3b30; color:#fff">X√≥a</button>
            <a id="downloadLink" class="btn-modal" style="background:#007aff; color:#fff; text-decoration:none; display:flex; align-items:center;">L∆∞u</a>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const gallery = document.getElementById('gallery');
        const zoomInput = document.getElementById('zoomInput');
        const zoomText = document.getElementById('zoom-text');
        const zoomToggle = document.getElementById('zoomToggle');
        const zoomInputContainer = document.getElementById('zoomInputContainer');
        const statusEl = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        const timerEl = document.getElementById('timer');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const downloadLink = document.getElementById('downloadLink');
        const delCurrentBtn = document.getElementById('delCurrentBtn');

        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let timerInterval;
        let currentFacingMode = "user"; 
        let currentStream;
        let currentGalleryItems = [];

        // 1. Kh·ªüi t·∫°o Camera
        async function initCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
            }
            try {
                const constraints = {
                    video: { facingMode: currentFacingMode },
                    audio: true
                };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // L·∫≠t ƒë√∫ng chi·ªÅu cho camera selfie
                video.style.transform = (currentFacingMode === "user") ? "scaleX(-1)" : "scaleX(1)";
                statusEl.innerText = (currentFacingMode === "user" ? "üì∑ Cam Tr∆∞·ªõc" : "üì∑ Cam Sau");
                
                // Reset zoom
                zoomInput.value = 1;
                zoomText.innerText = "1.0x";
                applyZoom(1);

            } catch (err) {
                statusEl.innerText = "L·ªói quy·ªÅn camera!";
                console.error(err);
            }
        }

        // 2. Zoom Toggle
        zoomToggle.onclick = () => {
            const isVisible = zoomInputContainer.style.display === 'flex';
            zoomInputContainer.style.display = isVisible ? 'none' : 'flex';
            zoomToggle.classList.toggle('active', !isVisible);
        };

        zoomInput.oninput = (e) => {
            const val = e.target.value;
            zoomText.innerText = parseFloat(val).toFixed(1) + "x";
            applyZoom(val);
        };

        function applyZoom(val) {
            const mirror = (currentFacingMode === "user") ? -1 : 1;
            video.style.transform = `scale(${val}) scaleX(${mirror})`;
        }

        // 3. Ch·ª•p ·∫£nh (X·ª≠ l√Ω ƒë√∫ng chi·ªÅu v√† Zoom)
        function takePhoto() {
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            const zoom = parseFloat(zoomInput.value);
            
            ctx.save();
            // L·∫≠t ·∫£nh n·∫øu l√† cam selfie ƒë·ªÉ l∆∞u ƒë√∫ng chi·ªÅu th·ª±c t·∫ø
            if (currentFacingMode === "user") {
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
            }
            
            // T√≠nh to√°n v√πng v·∫Ω d·ª±a tr√™n Zoom
            const sw = canvas.width / zoom;
            const sh = canvas.height / zoom;
            const sx = (canvas.width - sw) / 2;
            const sy = (canvas.height - sh) / 2;
            
            ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
            ctx.restore();
            
            const url = canvas.toDataURL('image/png');
            saveToGallery(url, 'image');

            video.style.opacity = 0.5;
            setTimeout(() => video.style.opacity = 1, 100);
        }

        // 4. Quay Video
        function toggleRecording() {
            if (!isRecording) {
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(currentStream);
                mediaRecorder.ondataavailable = (e) => e.data.size > 0 && recordedChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    saveToGallery(url, 'video');
                };
                mediaRecorder.start();
                isRecording = true;
                recordBtn.classList.add('recording');
                startTimer();
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.classList.remove('recording');
                stopTimer();
            }
        }

        // 5. B·ªô s∆∞u t·∫≠p & X√≥a
        function saveToGallery(url, type) {
            const id = Date.now();
            const item = { id, url, type };
            currentGalleryItems.push(item);
            renderGallery();
        }

        function renderGallery() {
            gallery.innerHTML = '';
            currentGalleryItems.forEach(item => {
                const wrapper = document.createElement('div');
                wrapper.className = 'gallery-item-wrapper';
                
                const media = document.createElement(item.type === 'image' ? 'img' : 'video');
                media.src = item.url;
                media.className = 'gallery-item';
                media.onclick = () => openModal(item);
                
                const delBtn = document.createElement('button');
                delBtn.innerHTML = '√ó';
                delBtn.className = 'delete-btn';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteItem(item.id);
                };
                
                wrapper.appendChild(media);
                wrapper.appendChild(delBtn);
                gallery.prepend(wrapper);
            });
        }

        function deleteItem(id) {
            currentGalleryItems = currentGalleryItems.filter(i => i.id !== id);
            renderGallery();
            closeModal();
        }

        // 6. Xem l·∫°i
        function openModal(item) {
            modalContent.innerHTML = '';
            const el = document.createElement(item.type === 'image' ? 'img' : 'video');
            el.src = item.url;
            if (item.type === 'video') el.controls = true;
            modalContent.appendChild(el);
            
            downloadLink.href = item.url;
            downloadLink.download = `camera_${item.id}.${item.type === 'image' ? 'png' : 'webm'}`;
            
            delCurrentBtn.onclick = () => deleteItem(item.id);
            modal.style.display = 'flex';
        }

        function closeModal() { modal.style.display = 'none'; modalContent.innerHTML = ''; }

        function toggleCamera() {
            currentFacingMode = (currentFacingMode === "user") ? "environment" : "user";
            initCamera();
        }

        function startTimer() {
            let s = 0;
            timerEl.innerText = "00:00";
            timerEl.style.display = 'block';
            timerInterval = setInterval(() => {
                s++;
                const min = Math.floor(s/60).toString().padStart(2,'0');
                const sec = (s%60).toString().padStart(2,'0');
                timerEl.innerText = `${min}:${sec}`;
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); timerEl.style.display = 'none'; }

        window.onload = initCamera;
    </script>
</body>
</html>
